# ğŸš€ Nombre del workflow â€” aparecerÃ¡ en la pestaÃ±a â€œActionsâ€ de GitHub
name: Deploy Astro to GitHub Pages

# ğŸ“¦ Evento que dispara el workflow
on:
  # 1ï¸âƒ£ Se ejecuta automÃ¡ticamente cada vez que se hace push a la rama â€œmainâ€
  push:
    branches: [ "main" ]
  # 2ï¸âƒ£ TambiÃ©n se puede ejecutar manualmente desde GitHub (botÃ³n â€œRun workflowâ€)
  workflow_dispatch:

# ğŸ”’ Permisos mÃ­nimos que necesita para desplegar en GitHub Pages
permissions:
  contents: read # Puede leer el contenido del repositorio
  pages: write # Puede subir archivos al sistema de GitHub Pages
  id-token: write # Permite autenticarse de forma segura con OIDC


# âš™ï¸ Controla la concurrencia: si se hacen varios pushes seguidos, cancela los anteriores para no sobrecargar los despliegues.
concurrency:
  group: "pages"
  cancel-in-progress: true

# ğŸ§± DefiniciÃ³n de los trabajos (â€œjobsâ€) del pipeline
jobs:

  # --- JOB 1: Build ---
  build:
    # ğŸ”§ Sistema operativo donde se ejecutarÃ¡n los comandos
    runs-on: ubuntu-latest

    # ğŸ§± Pasos del job de build
    steps:
      # Paso 1ï¸âƒ£ â€” Descarga el cÃ³digo del repositorio
      - name: Checkout
        uses: actions/checkout@v4

      # Paso 2ï¸âƒ£ â€” Configura Node.js (versiÃ³n 20) y habilita cache automÃ¡tico para acelerar instalaciones
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Paso 3ï¸âƒ£ â€” Instala dependencias segÃºn el package-lock.json
      - name: Install deps
        run: npm ci

      # Paso 4ï¸âƒ£ â€” Compila el sitio Astro â†’ genera la carpeta /dist
      - name: Build
        run: npm run build   # ğŸ‘‰ AquÃ­ Astro compila src/pages/*.astro â†’ dist/

      # Paso 5ï¸âƒ£ â€” Empaqueta el resultado para pasarlo al siguiente job (deploy)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist        # ğŸ‘‰ MUY IMPORTANTE: publicar SOLO la carpeta dist

  # --- JOB 2: Deploy ---
  deploy:
    # ğŸ”— Espera a que el job â€œbuildâ€ termine correctamente
    needs: build

    # Se ejecuta en el mismo sistema (Ubuntu)
    runs-on: ubuntu-latest

    # ğŸ“ Define el entorno de despliegue (aparece en la pestaÃ±a â€œEnvironmentsâ€)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # ğŸ§± Pasos del job de deploy
    steps:
      # Paso Ãºnico â€” Publica el artefacto anterior en GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4