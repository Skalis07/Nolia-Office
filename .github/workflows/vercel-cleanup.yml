name: Delete Vercel preview on merge

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: List preview deployments for this project
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          set -euo pipefail
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "PR branch merged: $PR_BRANCH"

          url="https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&target=preview&limit=100&teamId=$VERCEL_TEAM_ID"
          echo "GET $url"

          curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" "$url" > deployments.json
          node -e "const d=require('./deployments.json'); console.log('deployments returned:', (d.deployments||[]).length);"

      - name: Pick deployments that belong to this PR branch
        env:
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail
          node <<'NODE'
          const fs = require('fs');

          const branch = process.env.PR_BRANCH;
          const data = JSON.parse(fs.readFileSync('deployments.json', 'utf8'));
          const deployments = data.deployments || [];

          const matches = deployments.filter(d => {
            return d?.meta?.githubCommitRef === branch;
          });

          const ids = matches.map(d => d.uid).filter(Boolean);

          console.log(`Branch ${branch}: matched ${ids.length} preview deployment(s)`);
          if (matches[0]) {
            console.log('Example match meta:', matches[0].meta);
          }

          fs.writeFileSync('to-delete.txt', ids.join('\n') + (ids.length ? '\n' : ''));
          NODE

      - name: Delete matched deployments
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -s to-delete.txt ]; then
            echo "Nothing to delete for this PR."
            exit 0
          fi

          while IFS= read -r id; do
            echo "Deleting $id"
            status=$(curl -sS -o /tmp/out -w "%{http_code}" -X DELETE \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v13/deployments/$id")

            echo "HTTP $status"
            if [ "$status" -ge 400 ]; then
              echo "Response body:"
              cat /tmp/out || true
              exit 1
            fi
          done < to-delete.txt
